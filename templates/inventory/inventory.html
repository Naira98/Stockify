{% extends 'base.html' %}
{% load static %}

{% block sidebar %} 
    {% include 'components/sidebar.html' with active='inventory' %}
{% endblock sidebar %} 

{% block content %}


  <div class=" flex justify-end gap-4">
    <a href="{% url 'inventory:addproduct' %}" 
       class="w-60 px-4 py-2 rounded-md border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-400">
      Add new Product
    </a>
     <a href="{% url 'inventory:addcategory' %}" 
       class="w-60 px-4 py-2 rounded-md border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-400">
      Add new category
    </a>
      <a href="{% url 'inventory:deletecategory' %}" 
       class="w-60 px-4 py-2 rounded-md border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-400">
      delete category
    </a>
</div>

  <!-- Filter Controls -->
  <div class="mb-6 flex flex-wrap items-center gap-4 mt-4">
    <!-- Category Dropdown -->
    <div>
      <label for="category" class="block mb-2 text-sm font-medium text-gray-700">Select Category</label>
      <select id="category" name="category" class="w-60 px-4 py-2 rounded-md border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-400">
        <option value="">All Categories</option>
        {% for category in categories %}
          <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Stock Filter Buttons -->
    <div class="flex gap-2 mt-6">
      <button id="low_stock_btn" type="button" 
              class="px-4 py-2 rounded-md border {% if low_stock_filter %}bg-yellow-100 border-yellow-500 text-yellow-800{% else %}bg-white border-gray-300 text-gray-700{% endif %} hover:bg-yellow-50 transition-colors">
        Low Stock
      </button>
      <button id="out_of_stock_btn" type="button" 
              class="px-4 py-2 rounded-md border {% if out_of_stock_filter %}bg-red-100 border-red-500 text-red-800{% else %}bg-white border-gray-300 text-gray-700{% endif %} hover:bg-red-50 transition-colors">
        zero Stock
      </button>
    </div>

    <!-- Search Bar -->
    <div class="mt-6 flex-1 max-w-md">
      <label for="search" class="sr-only">Search</label>
      <div class="relative flex items-center">
        <input type="text" id="search" name="search" 
               placeholder="Search by product name..." 
               value="{{ current_search }}"
               class="w-full px-4 py-2 rounded-md border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-400">
        {% if current_search %}
        <button id="reset_search" type="button" class="absolute right-10 text-gray-400 hover:text-gray-600">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        {% endif %}
        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Cards Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    {% for product in products %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow">
      <div class="relative">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-48 object-cover">
        {% else %}
          <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
            <span class="text-gray-500">No image</span>
          </div>
        {% endif %}
        <div class="absolute top-2 right-2">
          <span class="px-2 py-1 rounded-full text-xs font-medium 
            {% if product.quantity == 0 %}bg-red-100 text-red-800
            {% elif product.quantity > 0 and product.quantity <= product.critical_amount %}bg-yellow-100 text-yellow-800
            {% else %}bg-green-100 text-green-800{% endif %}">
            {% if product.quantity == 0 %}Out of Stock
            {% elif product.quantity > 0 and product.quantity <= product.critical_amount %}Low Stock
            {% else %}In Stock{% endif %}
          </span>
      
        </div>
      </div>
      <div class="p-4">
        <h3 class="font-semibold text-lg text-gray-800 truncate">{{ product.name }}</h3>
        <p class="text-sm text-gray-500 mt-1">Category: {{ product.category.name }}</p>
        <p class="text-sm mt-1">
          <span class="{% if product.quantity == 0 %}text-red-600
                      {% elif product.quantity > 0 and product.quantity <= product.critical_amount %}text-yellow-600
                      {% else %}text-gray-500{% endif %}">
            Stock: {{ product.quantity }}<span> | critical_amount:{{product.critical_amount}}</span>
          </span>
        </p>
        {% if product.description %}
        <p class="text-sm text-gray-500 mt-2 line-clamp-2">{{ product.description }}</p>
        {% endif %}
      </div>
      <div class="px-4 pb-4 flex  justify-end gap-4">
        <a href="{% url 'inventory:details' pk=product.id %}" 
           class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
          <i class="fa-solid fa-circle-info"></i>
        </a>
         <a href="{% url 'inventory:deleteproduct' pk=product.id %}" 
           class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
          <i class="fa-solid fa-trash-can"></i>
        </a>
         <a href="{% url 'inventory:editproduct' pk=product.id %}" 
           class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
      <i class="fa-solid fa-pencil"></i>
        </a>
      </div>
    </div>
    {% empty %}
    <div class="col-span-3 text-center py-10">
      <p class="text-gray-500">No products found matching your criteria.</p>
      {% if low_stock_filter %}
        <p class="text-sm text-gray-400">No products with stock >0 and â‰¤ critical amount</p>
      {% elif out_of_stock_filter %}
        <p class="text-sm text-gray-400">No products completely out of stock (quantity = 0)</p>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Pagination Controls -->
  {% if page_obj.paginator.num_pages > 1 %}
  <div class="flex justify-center mt-8">
    <div class="flex items-center gap-4">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if low_stock_filter %}&low_stock=true{% endif %}{% if out_of_stock_filter %}&out_of_stock=true{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}" 
           class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
          Previous
        </a>
      {% else %}
        <button disabled class="px-4 py-2 rounded-md border border-gray-300 text-gray-400 cursor-not-allowed">
          Previous
        </button>
      {% endif %}
      
      <span class="text-gray-700">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
      
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if low_stock_filter %}&low_stock=true{% endif %}{% if out_of_stock_filter %}&out_of_stock=true{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}" 
           class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
          Next
        </a>
      {% else %}
        <button disabled class="px-4 py-2 rounded-md border border-gray-300 text-gray-400 cursor-not-allowed">
          Next
        </button>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Filtering JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const categorySelect = document.getElementById('category');
  const lowStockBtn = document.getElementById('low_stock_btn');
  const outOfStockBtn = document.getElementById('out_of_stock_btn');
  const searchInput = document.getElementById('search');
  const resetSearchBtn = document.getElementById('reset_search');
  
  // Get current filter state from URL
  const urlParams = new URLSearchParams(window.location.search);
  const currentLowStock = urlParams.get('low_stock') === 'true';
  const currentOutOfStock = urlParams.get('out_of_stock') === 'true';
  
  // Update button appearance based on current filter
  if (currentLowStock) {
    lowStockBtn.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
    lowStockBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
    // Ensure out of stock is off when low stock is on
    outOfStockBtn.classList.remove('bg-red-100', 'border-red-500', 'text-red-800');
    outOfStockBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
  }
  
  if (currentOutOfStock) {
    outOfStockBtn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
    outOfStockBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
    // Ensure low stock is off when out of stock is on
    lowStockBtn.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
    lowStockBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
  }

  function applyFilters() {
    const categoryId = categorySelect.value;
    const lowStockOnly = lowStockBtn.classList.contains('bg-yellow-100');
    const outOfStockOnly = outOfStockBtn.classList.contains('bg-red-100');
    const searchQuery = searchInput.value.trim();
    
    let url = '?';
    if (categoryId) url += `category=${categoryId}&`;
    if (lowStockOnly) url += 'low_stock=true&';
    if (outOfStockOnly) url += 'out_of_stock=true&';
    if (searchQuery) url += `search=${encodeURIComponent(searchQuery)}&`;
    
    // Remove trailing & if exists
    url = url.replace(/&$/, '');
    window.location.href = url || window.location.pathname;
  }

  // Toggle low stock filter on button click
  lowStockBtn.addEventListener('click', function() {
    // If clicking an already active filter, turn it off
    if (this.classList.contains('bg-yellow-100')) {
      this.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
      this.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
    } else {
      // Activate low stock and deactivate out of stock
      this.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
      this.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
      outOfStockBtn.classList.remove('bg-red-100', 'border-red-500', 'text-red-800');
      outOfStockBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
    }
    applyFilters();
  });
  
  // Toggle out of stock filter on button click
  outOfStockBtn.addEventListener('click', function() {
    // If clicking an already active filter, turn it off
    if (this.classList.contains('bg-red-100')) {
      this.classList.remove('bg-red-100', 'border-red-500', 'text-red-800');
      this.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
    } else {
      // Activate out of stock and deactivate low stock
      this.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
      this.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
      lowStockBtn.classList.remove('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
      lowStockBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
    }
    applyFilters();
  });

  // Apply filters when category changes
  categorySelect.addEventListener('change', applyFilters);
  
  // Apply filters when search input changes (with debounce)
 
  // Also apply when pressing Enter
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      applyFilters();
    }
  });
  
  // Reset search when X button is clicked
  if (resetSearchBtn) {
    resetSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      applyFilters();
    });
  }
});
</script>
{% endblock %}



















